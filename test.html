<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bar Chart Race</title>
    <script src="https://d3js.org/d3.v6.min.js"></script>
    <style>
        body {
            font-family: sans-serif;
        }
        .bar {
            fill: steelblue;
        }
        .label {
            font-size: 14px;
            fill: black;
        }
        .title {
            font-size: 24px;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <h1>Bar Chart Race for Song Playtime</h1>
    <svg width="1600" height="800"></svg>

    <script>
        const margin = { top: 50, right: 30, bottom: 50, left: 300 };
        const width = 1200 - margin.left - margin.right;
        const height = 700 - margin.top - margin.bottom;

        const svg = d3.select("svg")
            .attr("width", width + margin.left + margin.right)
            .attr("height", height + margin.top + margin.bottom)
            .append("g")
            .attr("transform", `translate(${margin.left},${margin.top})`);

        const duration = 600;  // Double the speed (half the original time)

        // Load the data from JSON
        d3.json('cumulative_for_barchart.json').then(data => {

            // Process the data into a format suitable for D3
            const dates = data.map(d => d.date);  // Extract all dates
            const allSongs = [...new Set(data.flatMap(d => d.songs.map(song => song.name)))]; // Unique song names

            // Set up scales
            const xScale = d3.scaleLinear().range([0, width]);
            const yScale = d3.scaleBand().range([0, height]).padding(0.1);

            // Create axes
            const xAxis = svg.append("g")
                .attr("transform", `translate(0, ${height})`);

            const yAxis = svg.append("g");

            // Create a function to draw the chart
            function drawChart(dateIndex) {
                const currentDate = dates[dateIndex];
                const currentData = data[dateIndex].songs.sort((a, b) => b.playtime - a.playtime).slice(0, 25);

                // Convert playtime from milliseconds to minutes
                currentData.forEach(d => d.playtimeMinutes = d.playtime / (1000 * 60));

                // Update scales
                xScale.domain([0, d3.max(currentData, d => d.playtimeMinutes)]);
                yScale.domain(currentData.map(d => d.name));

                // Update axes
                xAxis.transition().duration(duration).call(d3.axisBottom(xScale).ticks(10).tickFormat(d => `${d} min`));
                yAxis.transition().duration(duration).call(d3.axisLeft(yScale));

                // Join the data
                const bars = svg.selectAll(".bar")
                    .data(currentData, d => d.name);

                // Enter new bars
                bars.enter().append("rect")
                    .attr("class", "bar")
                    .attr("x", 0)
                    .attr("y", d => yScale(d.name))
                    .attr("width", d => xScale(d.playtimeMinutes))
                    .attr("height", yScale.bandwidth())
                    .style("fill", "steelblue")
                    .merge(bars)
                    .transition().duration(duration)
                    .attr("y", d => yScale(d.name))
                    .attr("width", d => xScale(d.playtimeMinutes));

                // Remove old bars
                bars.exit().remove();

                // Add labels for each bar
                const labels = svg.selectAll(".label")
                    .data(currentData, d => d.name);

                labels.enter().append("text")
                    .attr("class", "label")
                    .attr("x", d => xScale(d.playtimeMinutes) + 5)
                    .attr("y", d => yScale(d.name) + yScale.bandwidth() / 2)
                    .attr("dy", ".35em")
                    .text(d => `${d.name} (${d.playtimeMinutes.toFixed(2)} min)`)
                    .merge(labels)
                    .transition().duration(duration)
                    .attr("x", d => xScale(d.playtimeMinutes) + 5)
                    .attr("y", d => yScale(d.name) + yScale.bandwidth() / 2)
                    .text(d => `${d.name} (${d.playtimeMinutes.toFixed(2)} min)`);

                labels.exit().remove();

                // Display date as title
                svg.selectAll(".title").remove();
                svg.append("text")
                    .attr("class", "title")
                    .attr("x", width / 2)
                    .attr("y", -10)
                    .attr("text-anchor", "middle")
                    .text(`Top Songs on ${currentDate}`);
            }

            // Animation
            let currentIndex = 0;
            function updateChart() {
                drawChart(currentIndex);
                currentIndex = (currentIndex + 1) % dates.length;
            }

            drawChart(currentIndex);  // Draw the first frame
            setInterval(updateChart, duration);  // Update the chart every interval
        });
    </script>
</body>
</html>
